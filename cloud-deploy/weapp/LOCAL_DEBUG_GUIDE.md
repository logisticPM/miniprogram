# 房产小程序云托管版 - 本地调试指南

本文档提供了如何在本地环境下调试微信小程序与云托管服务交互的指南。

## 准备工作

1. 安装最新版本的微信开发者工具
2. 确保已经创建了微信云开发环境
3. 确保已经创建了云托管服务

## 配置步骤

### 1. 配置云环境

打开 `config.js` 文件，设置以下参数：

```javascript
// 云环境ID
cloudEnv: 'your-cloud-env-id',  // 替换为你的云环境ID

// 云托管服务名称
serviceName: 'wxcloudrun-springboot',  // 替换为你的服务名称

// 是否使用云托管容器调用
useCloudContainer: true,  // 推荐设置为true，可以绕过域名限制
```

### 2. 开发者工具设置

1. 打开微信开发者工具
2. 导入项目
3. 在"详情"面板中：
   - 勾选"不校验合法域名"
   - 确保"增强编译"已开启
   - 确保"ES6 转 ES5"已开启

### 3. 测试API连接

1. 启动项目后，会自动进入首页
2. 首页会显示云环境配置信息和API连接状态
3. 点击"测试API连接"按钮可以手动测试API连接

## 常见问题解决

### 1. API连接失败 - INVALID_REQUEST (errCode: -501000)

如果遇到以下错误：
```
cloud.callContainer:fail Error: errCode: -501000 | errMsg: Invalid request
```

可能的原因：

- 云环境ID或服务名称配置错误
- 请求路径格式不正确
- 请求方法不匹配（GET vs POST）
- 云环境未正确初始化

解决方案：

1. **检查云环境配置**：
   - 确认`config.js`中的`cloudEnv`和`serviceName`与微信云托管控制台中的一致
   - 确保云环境ID格式正确（例如：`0d1hHa0w390gu43Oq0w3A1CXs1hHa0Z`）

2. **尝试不同的请求方法**：
   - 有些API可能只支持POST而不是GET，可以尝试切换请求方法
   - 在首页测试时，系统会自动尝试使用POST方法

3. **检查请求路径**：
   - 确保路径以`/`开头
   - 确认后端服务中确实存在该API路径

4. **重启开发者工具**：
   - 完全关闭并重新打开微信开发者工具
   - 清除缓存并重新编译项目

5. **检查云托管服务状态**：
   - 在微信云托管控制台确认服务是否正常运行
   - 查看服务日志是否有错误信息

### 2. API返回400状态码但连接成功

如果遇到以下情况：
```
[DEBUG] 云托管调用成功: /api/health {statusCode: 400, ...}
[ERROR] API连接测试失败: {code: "INVALID_REQUEST", message: "Invalid request. ..."}
```

这表示云托管容器调用本身是成功的，但后端API返回了400错误。这通常意味着：

1. **请求格式问题**：
   - 后端API期望特定格式的请求体或参数
   - 可能需要特定的请求头或认证信息

2. **API实现问题**：
   - 后端API可能有bug或配置问题
   - 可能是API版本不匹配

解决方案：

1. **使用模拟响应**：
   - 当前版本已实现自动模拟响应功能，可以继续开发
   - 如果看到"连接成功(模拟)"，表示使用了模拟响应

2. **检查后端API实现**：
   - 查看后端API的源代码，了解它期望的请求格式
   - 可能需要修改API实现或请求格式

3. **使用其他API测试**：
   - 尝试调用其他API，如`/api/count`
   - 使用POST方法并提供正确的请求体格式

### 3. 域名白名单问题

如果使用普通HTTP请求（关闭云托管容器调用），需要在微信公众平台添加以下域名到request合法域名：

```
https://{你的服务名称}-{你的环境ID}.ap-shanghai.app.tcloudbase.com
```

### 4. 云环境初始化失败

如果云环境初始化失败，请检查：

- 云环境ID是否正确
- 是否有足够的权限
- 微信开发者工具是否为最新版本

## 调试技巧

1. **查看控制台日志**：开发者工具 -> 调试器 -> Console
   - 查找带有`[DEBUG]`和`[ERROR]`前缀的日志
   - 特别关注云环境初始化和API调用相关的日志

2. **使用云托管容器调用**：
   - 开启首页的"云托管容器调用"开关
   - 这种方式可以绕过域名限制，更适合开发调试

3. **检查网络请求**：
   - 开发者工具 -> 调试器 -> Network
   - 查看请求的详细信息，包括请求头、响应状态和响应内容

4. **使用POST方法测试**：
   - 如果GET方法失败，尝试使用POST方法
   - 有些后端API可能只支持特定的HTTP方法

5. **使用模拟响应**：
   - 如果API返回400错误但连接成功，可以使用模拟响应继续开发
   - 这种方式可以在后端API修复前继续前端开发

## 部署上线

在完成本地调试后，请确保：

1. 在微信公众平台添加必要的域名到白名单
2. 关闭开发者工具中的"不校验合法域名"选项进行最终测试
3. 使用云托管容器调用方式可以绕过域名限制，更适合生产环境

如有更多问题，请参考微信云开发和云托管的官方文档。 